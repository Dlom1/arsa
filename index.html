<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arsa Mobile Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f2f4f7;
            --card: #ffffff;
            --text: #101828;
            --subtext: #667085;
            --primary: #007aff; /* Mobile Blue */
            --danger: #ef4444;
            --select-bg: #eff8ff;
            --border: #eaecf0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* --- DASHBOARD STATS --- */
        .stats-container {
            background: var(--card);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-box h1 { font-size: 1.2rem; font-weight: 800; color: var(--text); }
        .stat-details { font-size: 0.85rem; color: var(--subtext); margin-top: 4px; font-weight: 600; }
        .stat-badge { 
            background: #d1fae5; color: #065f46; padding: 4px 8px; 
            border-radius: 6px; font-size: 0.75rem; font-weight: 700;
        }

        /* --- UPLOAD AREA --- */
        .upload-section { margin: 15px; position: relative; }
        .btn-upload {
            background: var(--text); color: white; width: 100%; padding: 14px;
            border-radius: 12px; font-weight: 600; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-upload:active { transform: scale(0.98); }
        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; }

        /* --- GRID GALLERY --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Kolom di HP */
            gap: 4px;
            padding: 0 4px;
        }
        
        .photo-card {
            position: relative;
            aspect-ratio: 1/1;
            background: #e5e7eb;
            overflow: hidden;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .photo-card img {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.2s;
        }

        /* Mode Seleksi */
        .photo-card.selected::after {
            content: "âœ”";
            position: absolute; inset: 0;
            background: rgba(0, 122, 255, 0.4);
            border: 4px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 2rem; font-weight: bold;
        }

        /* --- STICKY ACTION BAR (Muncul saat select) --- */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px;
            border-top: 1px solid var(--border);
            display: none; /* Hidden by default */
            justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .action-bar.show { display: flex; animation: slideUp 0.3s; }
        
        .btn-cancel { color: var(--text); font-weight: 600; padding: 10px 20px; background: transparent; border: none; }
        .btn-delete { 
            background: var(--danger); color: white; padding: 10px 24px; 
            border-radius: 50px; font-weight: 600; border: none; 
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        /* --- PROGRESS OVERLAY --- */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 200; display: none; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            text-align: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Helper Text jika kosong */
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--subtext); }

    </style>
</head>
<body>

    <div class="stats-container">
        <div class="stat-box">
            <h1>Arsa Manager</h1>
            <div class="stat-details" id="stat-text">Memuat data...</div>
        </div>
        <div class="stat-badge" id="size-badge">0 MB</div>
    </div>

    <div class="upload-section">
        <button class="btn-upload">
            <span>+ Upload Foto Baru</span>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </button>
        <div style="text-align: center; font-size: 11px; color: #999; margin-top: 8px;">
            Otomatis kompres < 900KB
        </div>
    </div>

    <div id="gallery" class="gallery-grid">
        </div>

    <div id="actionBar" class="action-bar">
        <button class="btn-cancel" onclick="exitSelectionMode()">Batal</button>
        <span id="select-count" style="font-weight: 600; font-size: 14px;">0 Dipilih</span>
        <button class="btn-delete" onclick="deleteSelectedPhotos()">Hapus</button>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Sedang memproses...</div>
    </div>

    <script>
        // --- KONFIGURASI (JANGAN LUPA TOKEN) ---
        const USERNAME = 'Dlom1';
        const REPO = 'arsa';
        const GITHUB_TOKEN = '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'; // Pastikan token ini valid!

        // Variables
        let allFiles = [];
        let selectedSHAs = new Set();
        let isSelectionMode = false;
        let longPressTimer;

        // Elements
        const gallery = document.getElementById('gallery');
        const statText = document.getElementById('stat-text');
        const sizeBadge = document.getElementById('size-badge');
        const actionBar = document.getElementById('actionBar');
        const selectCount = document.getElementById('select-count');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // --- 1. CORE: LOAD GALLERY & STATS ---
        async function loadGallery() {
            showLoading(false);
            try {
                const res = await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Cache-Control': 'no-cache' }
                });
                
                if (!res.ok) throw new Error("Gagal koneksi");
                const files = await res.json();
                
                // Filter Gambar
                const imageExts = ['jpg', 'jpeg', 'png', 'webp'];
                allFiles = Array.isArray(files) ? files.filter(f => imageExts.includes(f.name.split('.').pop().toLowerCase())) : [];

                // Hitung Statistik
                calculateStats(allFiles);

                // Render Galeri
                renderGrid();

            } catch (e) {
                gallery.innerHTML = '<div class="empty-state">Gagal memuat data. Periksa koneksi/Token.</div>';
            }
        }

        function calculateStats(files) {
            const count = files.length;
            let totalBytes = 0;
            files.forEach(f => totalBytes += f.size);

            // Konversi ke MB / KB
            let sizeStr = '';
            if (totalBytes > 1024 * 1024) {
                sizeStr = (totalBytes / (1024 * 1024)).toFixed(2) + ' MB';
            } else {
                sizeStr = (totalBytes / 1024).toFixed(0) + ' KB';
            }

            statText.innerText = `${count} Foto Tersimpan`;
            sizeBadge.innerText = sizeStr;
        }

        function renderGrid() {
            gallery.innerHTML = '';
            if (allFiles.length === 0) {
                gallery.innerHTML = '<div class="empty-state">Belum ada foto.</div>';
                return;
            }

            // Sort terbaru di atas (berdasarkan nama file jika format tanggal, atau default)
            // allFiles.sort((a, b) => b.name.localeCompare(a.name)); 

            allFiles.forEach(file => {
                const card = document.createElement('div');
                card.className = `photo-card ${selectedSHAs.has(file.sha) ? 'selected' : ''}`;
                
                // Event Handlers untuk Long Press & Click
                card.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); return false; }; // Disable menu klik kanan default
                
                // Touch Start (Untuk Long Press di HP)
                card.ontouchstart = (e) => startLongPress(e, file.sha);
                card.ontouchend = () => cancelLongPress();
                card.onmousedown = (e) => startLongPress(e, file.sha); // Untuk Desktop
                card.onmouseup = () => cancelLongPress();

                // Click biasa
                card.onclick = () => handleCardClick(file, card);

                card.innerHTML = `<img src="${file.download_url}" loading="lazy">`;
                gallery.appendChild(card);
            });
        }

        // --- 2. UPLOAD DENGAN KOMPRESI (900KB LIMIT) ---
        document.getElementById('fileInput').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length) return;

            showLoading(true, "Mengompresi & Mengunggah...");

            for (let i = 0; i < files.length; i++) {
                try {
                    const compressedBase64 = await compressImage(files[i]);
                    await uploadToGithub(files[i].name, compressedBase64);
                } catch (err) {
                    console.error("Gagal upload:", err);
                    alert(`Gagal upload ${files[i].name}`);
                }
            }

            showLoading(false);
            loadGallery(); // Refresh
        };

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxSize = 900 * 1024; // 900KB
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Resize jika resolusi terlalu besar (misal > 2000px)
                        const MAX_DIM = 2000; 
                        if (width > height && width > MAX_DIM) {
                            height *= MAX_DIM / width;
                            width = MAX_DIM;
                        } else if (height > MAX_DIM) {
                            width *= MAX_DIM / height;
                            height = MAX_DIM;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Fungsi rekursif untuk menurunkan kualitas sampai < 900KB
                        let quality = 0.9;
                        
                        function tryCompress() {
                            canvas.toBlob((blob) => {
                                if (blob.size <= maxSize || quality <= 0.2) {
                                    // Sudah cukup kecil atau kualitas mentok
                                    const reader2 = new FileReader();
                                    reader2.readAsDataURL(blob);
                                    reader2.onloadend = () => resolve(reader2.result.split(',')[1]);
                                } else {
                                    // Masih kegedean, kurangi kualitas
                                    quality -= 0.1;
                                    tryCompress();
                                }
                            }, 'image/jpeg', quality);
                        }
                        
                        tryCompress();
                    };
                };
                reader.onerror = error => reject(error);
            });
        }

        async function uploadToGithub(filename, content) {
            const cleanName = filename.replace(/\s+/g, '_').split('.')[0] + '.jpg'; // Paksa jadi JPG
            await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${cleanName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Mobile Upload ${cleanName}`, content: content })
            });
        }

        // --- 3. SELECTION & BATCH DELETE (INTERAKSI) ---
        
        function startLongPress(e, sha) {
            longPressTimer = setTimeout(() => {
                enterSelectionMode();
                toggleSelection(sha);
                navigator.vibrate(50); // Haptic feedback
            }, 600); // 0.6 detik tahan untuk select
        }

        function cancelLongPress() {
            clearTimeout(longPressTimer);
        }

        function handleCardClick(file, cardElement) {
            if (isSelectionMode) {
                toggleSelection(file.sha);
            } else {
                // Jika tidak mode seleksi, buka gambar (Preview)
                window.open(file.download_url, '_blank');
            }
        }

        function enterSelectionMode() {
            isSelectionMode = true;
            actionBar.classList.add('show');
        }

        function exitSelectionMode() {
            isSelectionMode = false;
            selectedSHAs.clear();
            actionBar.classList.remove('show');
            renderGrid(); // Redraw untuk hilangkan centang
        }

        function toggleSelection(sha) {
            if (selectedSHAs.has(sha)) {
                selectedSHAs.delete(sha);
            } else {
                selectedSHAs.add(sha);
            }
            
            // Update UI Card
            renderGrid();
            
            // Update Text Jumlah
            selectCount.innerText = `${selectedSHAs.size} Dipilih`;

            // Jika kosong, keluar mode seleksi
            if (selectedSHAs.size === 0) exitSelectionMode();
        }

        async function deleteSelectedPhotos() {
            const count = selectedSHAs.size;
            if (count === 0) return;
            if (!confirm(`Hapus ${count} foto yang dipilih secara permanen?`)) return;

            showLoading(true, `Menghapus ${count} foto...`);

            // Ubah Set ke Array untuk loop
            const itemsToDelete = Array.from(selectedSHAs);
            
            // Cari path file berdasarkan SHA
            const deletePromises = itemsToDelete.map(sha => {
                const file = allFiles.find(f => f.sha === sha);
                if (file) {
                    return fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file.path}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: 'Batch Delete via Web', sha: sha })
                    });
                }
            });

            await Promise.all(deletePromises);
            
            showLoading(false);
            exitSelectionMode();
            loadGallery();
        }

        // Helper UI
        function showLoading(show, text = "") {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            if(text) loadingText.innerText = text;
        }

        // Init
        loadGallery();

    </script>
</body>
</html>
